import os
import json
import time
import asyncio
from dotenv import load_dotenv
{% if _wallet_provider == "server" %}from coinbase_agentkit import CdpEvmServerWalletProviderConfig{% elif _wallet_provider == "smart" %}from coinbase_agentkit import CdpEvmSmartWalletProviderConfig{% elif _wallet_provider == "eth" %}from coinbase_agentkit import EthAccountWalletProviderConfig{% endif %}
{% if _wallet_provider == "eth" %}from eth_account import Account{% elif _wallet_provider == "smart" %}from cdp import CdpClient{% endif %}

from initialize_agent import initialize_agent

def setup():
    """Set up the agent with persistent wallet storage.

    Returns:
        tuple[Agent, dict]: The initialized agent and its configuration
    """
    # Configure network and file path{% if _wallet_provider == "server" or _wallet_provider == "smart" %}
    network_id = os.getenv("NETWORK_ID", "base-sepolia")
    wallet_file = f"wallet_data_{network_id.replace('-', '_')}.txt"
    {% elif _wallet_provider == "eth" %}chain_id = os.getenv("CHAIN_ID", "84532")
    wallet_file = f"wallet_data_{chain_id}.txt"{% endif %}
    # Load existing wallet data if available
    wallet_data = {}
    if os.path.exists(wallet_file):
        try:
            with open(wallet_file) as f:
                wallet_data = json.load(f)
                print(f"Loading existing wallet from {wallet_file}")
        except json.JSONDecodeError:
            print(f"Warning: Invalid wallet data in {wallet_file}")
            wallet_data = {}

    {% if _wallet_provider == "server" or _wallet_provider == "smart" %}# Get required CDP credentials
    api_key_id = os.getenv("CDP_API_KEY_ID")
    api_key_secret = os.getenv("CDP_API_KEY_SECRET")
    wallet_secret = os.getenv("CDP_WALLET_SECRET")

    if not all([api_key_id, api_key_secret, wallet_secret]):
        raise ValueError("CDP_API_KEY_ID, CDP_API_KEY_SECRET, and CDP_WALLET_SECRET are required"){% endif %}

    {% if _wallet_provider == "server" %}# Create server wallet config
    config = CdpEvmServerWalletProviderConfig(
        api_key_id=api_key_id,
        api_key_secret=api_key_secret,
        wallet_secret=wallet_secret,
        network_id=network_id,
        address=wallet_data.get("address") or os.getenv("ADDRESS"),
        idempotency_key=os.getenv("IDEMPOTENCY_KEY"),
    )
    {% elif _wallet_provider == "smart" %}# Determine owner using priority order
    owner = (
        os.getenv("OWNER_PRIVATE_KEY")  # First priority: Private key
        or os.getenv("OWNER_SERVER_WALLET_ADDRESS")  # Second priority: Server wallet address
        or wallet_data.get("owner")  # Third priority: Saved wallet file
    )

    # If no owner is provided, create a new server wallet to be used as the owner
    if not owner:
        print("No owner provided, creating new server wallet...")
        idempotency_key = os.getenv("OWNER_IDEMPOTENCY_KEY")
        
        # Create a new server wallet using CDP
        client = CdpClient(
            api_key_id=api_key_id,
            api_key_secret=api_key_secret,
            wallet_secret=wallet_secret,
        )
        async def create_wallet():
            async with client as cdp:
                account = await cdp.evm.create_account(idempotency_key=idempotency_key)
                return account.address
        owner = asyncio.run(create_wallet())
        print(f"Created new server wallet: {owner}")

    # Create smart wallet config
    config = CdpEvmSmartWalletProviderConfig(
        api_key_id=api_key_id,
        api_key_secret=api_key_secret,
        wallet_secret=wallet_secret,
        network_id=network_id,
        address=wallet_data.get("smart_wallet_address") or os.getenv("SMART_WALLET_ADDRESS"),
        owner=owner,
        paymaster_url=os.getenv("PAYMASTER_URL"),
    )
    {% elif _wallet_provider == "eth" %}# Get or generate private key
    private_key = (
        os.getenv("PRIVATE_KEY")  # First priority: Environment variable
        or wallet_data.get("private_key")  # Second priority: Saved wallet file
        or Account.create().key.hex()  # Third priority: Generate new key
    )

    # Ensure private key has 0x prefix
    if not private_key.startswith("0x"):
        private_key = f"0x{private_key}"

    # Create Ethereum account from private key
    account = Account.from_key(private_key)

    # Create eth wallet config
    config = EthAccountWalletProviderConfig(
        account=account,
        chain_id=chain_id,
    ){% endif %}
    # Initialize the agent
    agent_executor, wallet_provider = initialize_agent(config)

    # Save the wallet data after successful initialization{% if _wallet_provider == "server" %}
    new_wallet_data = {
        "address": wallet_provider.get_address(),
        "network_id": network_id,
        "created_at": time.strftime("%Y-%m-%d %H:%M:%S") if not wallet_data else wallet_data.get("created_at")
    }{% elif _wallet_provider == "smart" %}
    new_wallet_data = {
        "smart_wallet_address": wallet_provider.get_address(),
        "owner": owner,
        "network_id": network_id,
        "created_at": time.strftime("%Y-%m-%d %H:%M:%S") if not wallet_data else wallet_data.get("created_at")
    }{% elif _wallet_provider == "eth" %}
    new_wallet_data = {
        "private_key": private_key,
        "chain_id": chain_id,
        "created_at": time.strftime("%Y-%m-%d %H:%M:%S") if not wallet_data else wallet_data.get("created_at")
    }{% endif %}

    with open(wallet_file, "w") as f:
        json.dump(new_wallet_data, f, indent=2)
        print(f"Wallet data saved to {wallet_file}")

    {% if _framework == "langchain" %}agent_config = {"configurable": {"thread_id": "AgentKit Chatbot"}}
    return agent_executor, agent_config
    {% elif _framework == "openai_agents" %}return agent_executor{% endif %} 
